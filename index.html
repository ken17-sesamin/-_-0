<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±ä½œæ–‡ãƒ‘ã‚ºãƒ«ï¼ˆå¤§å•ï¼‹ãƒ’ãƒ³ãƒˆï¼‹ç·¨é›†ï¼‹è¨˜éŒ²ï¼‰</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#fff;
    --ink:#111;
    --muted:#666;
    --primary:#4a6cf7;
    --primary2:#10b981;
    --danger:#ef4444;
    --warn:#fb923c;
  }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    max-width: 980px;
    margin: 0 auto;
    padding: 18px 12px 80px;
    background: var(--bg);
    color: var(--ink);
  }
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap:wrap;
    margin: 8px 0 12px;
  }
  h1{ margin: 6px 0; font-size: 22px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .card{
    background: var(--card);
    padding: 16px;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,.06);
    margin-bottom: 14px;
  }
  .jp{
    font-size: 20px;
    font-weight: 900;
    padding: 12px 14px;
    border-left: 6px solid var(--primary);
    background: linear-gradient(90deg,#eef2ff,#ffffff);
    border-radius: 12px;
    margin: 6px 0 10px;
    line-height: 1.55;
  }
  .meta{ color: var(--muted); font-size: 13px; line-height: 1.6; }

  .box{
    border: 2px dashed #cfd3dc;
    padding: 10px;
    min-height: 60px;
    border-radius: 12px;
    background: #fff;
  }

  .word,.built{
    padding: 12px 16px;
    margin: 6px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 17px;
    line-height: 1.2;
  }
  .word{ background: #111827; color: #fff; }
  .built{ background: #dfe6ff; color: #111; }
  .word:disabled,.built:disabled{ opacity:.5; cursor:not-allowed; }

  .controls{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 6px; }
  button.ctrl{
    padding: 12px 16px;
    border: none;
    border-radius: 12px;
    background: var(--primary);
    color: #fff;
    cursor: pointer;
    font-size: 15px;
  }
  button.ctrl.gray{ background:#6b7280; }
  button.ctrl.green{ background: var(--primary2); }
  button.ctrl.danger{ background: var(--danger); }

  .result{ white-space: pre-line; font-weight: 900; font-size: 16px; margin: 10px 0 6px; }
  .correct{ color: #0a7f2e; }
  .wrong{ color: #c0392b; }

  .panel{
    margin-top: 10px;
    padding: 14px;
    border-radius: 12px;
    line-height: 1.65;
  }
  .explain{ background:#fff; border-left:6px solid var(--primary); }
  .hint{ background:#ecfdf5; border-left:6px solid var(--primary2); }
  .log{ background:#fff7ed; border-left:6px solid var(--warn); font-size: 14px; }

  .bigResult{
    text-align:center;
    font-size: 22px;
    font-weight: 900;
    margin: 8px 0 14px;
  }

  /* Editor */
  .editor{ display:none; }
  .editor h2{ margin: 0 0 10px; font-size: 18px; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  @media(max-width:760px){ .grid{ grid-template-columns: 1fr; } }
  .field label{ display:block; font-size: 12px; color: var(--muted); margin: 2px 0 6px; font-weight: 800; }
  .field input,.field textarea,.field select{
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    padding: 10px;
    font-size: 14px;
    box-sizing: border-box;
    background: #fff;
  }
  .field textarea{ min-height: 88px; resize: vertical; }
  .small{ color: var(--muted); font-size: 12px; margin-top: 6px; }

  /* Modal */
  .modal-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 9999;
  }
  .modal{
    width: min(760px, 100%);
    background: #fff;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 12px 34px rgba(0,0,0,.22);
  }
  .modal h2{ margin: 4px 0 10px; font-size: 18px; }
  .modal .summary{
    background:#f8fafc;
    border-radius: 12px;
    padding: 12px;
    line-height: 1.7;
  }
  .modal .miss{
    margin-top: 10px;
    background:#fff7ed;
    border-left:6px solid var(--warn);
    border-radius: 12px;
    padding: 12px;
    line-height: 1.7;
    font-size: 14px;
  }

  @media (max-width:600px){
    .word,.built{ width:100%; font-size:18px; }
    button.ctrl{ width:100%; }
  }
</style>
</head>
<body>

<div class="topbar">
  <h1>è‹±ä½œæ–‡ ä¸¦ã¹æ›¿ãˆãƒ‘ã‚ºãƒ«</h1>
  <div class="row">
    <button class="ctrl gray" id="btnEditor" onclick="toggleEditor()">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="ctrl gray" onclick="clearHistory()">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<div id="app"></div>

<!-- å¤§å•çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="groupModal" class="modal-backdrop" onclick="backdropClose(event)">
  <div class="modal" role="dialog" aria-modal="true">
    <h2 id="groupModalTitle">å¤§å•ã®çµæœ</h2>
    <div id="groupModalBody" class="summary"></div>
    <div id="groupModalMiss" class="miss" style="display:none;"></div>
    <div class="row" style="margin-top:12px;">
      <button class="ctrl green" onclick="goNextSection()">æ¬¡ã®å¤§å•ã¸</button>
      <button class="ctrl gray" onclick="retrySection()">ã“ã®å¤§å•ã‚’ã‚‚ã†ä¸€å›</button>
      <button class="ctrl gray" onclick="closeGroupModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
/********************
  ä¿å­˜ã‚­ãƒ¼
********************/
const LS_SECTIONS_KEY = "english_puzzle_sections_v4";
const COOKIE_HISTORY_KEY = "englishPuzzleHistory_v4";

/********************
  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œï¼ˆå¿…è¦ãªã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§å¢—ã‚„ã™ï¼‰
  â€»ã“ã“ã¯æœ€å°ã‚»ãƒƒãƒˆã€‚ã‚ãªãŸã®å…¨å•é¡Œã¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§è¿½åŠ ã§ãã¾ã™ã€‚
********************/
const DEFAULT_SECTIONS = [
  {
    title:"å¤§å•1",
    questions:[
      {
        id:"q1-1",
        jp:"ã©ã“ã§ã‚‚ãƒ‰ã‚¢ãŒã‚ã£ãŸã‚‰ã„ã„ã¨æ€ã„ã¾ã›ã‚“ã‹ã€‚",
        tokens:["an","anywhere","door","if","wouldn't","be","we","had","it","nice"],
        answer:"wouldn't it be nice if we had an anywhere door?",
        hint:"å‡ºã ã—ã¯ Wouldn't it be nice if...ï¼ˆä»®å®šæ³•ï¼‰",
        explain:"ä»®å®šæ³•ã€‚Wouldn't it be nice if ï½ ã¯è¶…é »å‡ºã€‚"
      },
      {
        id:"q1-2",
        jp:"ç§ã«ã¨ã£ã¦ã“ã®æ­Œã‚’æ­Œã†ã®ã¯ã¨ã¦ã‚‚é›£ã—ã„ã§ã™ã€‚",
        tokens:["this","song","for","sing","me","it","very","difficult","to","is"],
        answer:"it is very difficult for me to sing this song.",
        hint:"It is + å½¢å®¹è© + for + äºº + to + å‹•è©",
        explain:"It is + å½¢å®¹è© + for + äºº + to å‹•è©ã€‚"
      },
      {
        id:"q1-3",
        jp:"å¤§é›ªã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€åˆ—è»Šã¯æ™‚é–“é€šã‚Šã«åˆ°ç€ã—ã¾ã—ãŸã€‚",
        tokens:["the","train","on","the","heavy","snow","arrived","time","spite","of","in"],
        answer:"the train arrived on time in spite of the heavy snow.",
        hint:"in spite of + åè© / on time",
        explain:"in spite of = ï½ã«ã‚‚ã‹ã‹ã‚ã‚‰ãš"
      },
      {
        id:"q1-4",
        jp:"ç§ãŸã¡ã¯ä»Šæœæ—©ãã‹ã‚‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚",
        tokens:["preparing","this","morning","been","early","from","the","party","for","we've"],
        answer:"we've been preparing for the party from early this morning.",
        hint:"have been + -ingï¼ˆãšã£ã¨ã€œã—ã¦ã„ã‚‹ï¼‰",
        explain:"ç¾åœ¨å®Œäº†é€²è¡Œå½¢ã€‚"
      },
      {
        id:"q1-5",
        jp:"æ¯æ—¥30åˆ†ã®é‹å‹•ã‚’ã™ã‚‹ã“ã¨ã¯ã‚ãªãŸã®å¥åº·ã«ã‚ˆã„ã§ã—ã‚‡ã†ã€‚",
        tokens:["every","day","of","thirty","health","exercise","would","for","good","your","be","minutes"],
        answer:"thirty minutes of exercise every day would be good for your health.",
        hint:"ä¸»èªã¯ Thirty minutes of exercise",
        explain:"minutes of ï½ ã§ã€Œï½ã®åˆ†ã€ã€‚"
      }
    ]
  }
];

/********************
  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
********************/
function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
function normalize(s){
  return String(s).trim().replace(/\s+/g," ").toLowerCase();
}
function ensureIds(sections){
  // id ãŒç„¡ã„å•é¡Œã«è‡ªå‹•ä»˜ä¸ï¼ˆä¿å­˜å‰æï¼‰
  for(const sec of sections){
    for(const q of sec.questions){
      if(!q.id){
        q.id = "q-" + Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
      }
    }
  }
  return sections;
}

/********************
  æ°¸ç¶šåŒ–ï¼ˆsections: localStorage / history: cookieï¼‰
********************/
function loadSections(){
  const raw = localStorage.getItem(LS_SECTIONS_KEY);
  if(!raw) return ensureIds(structuredClone(DEFAULT_SECTIONS));
  try{
    const v = JSON.parse(raw);
    if(Array.isArray(v) && v.length) return ensureIds(v);
    return ensureIds(structuredClone(DEFAULT_SECTIONS));
  }catch{
    return ensureIds(structuredClone(DEFAULT_SECTIONS));
  }
}
function saveSections(){
  localStorage.setItem(LS_SECTIONS_KEY, JSON.stringify(sections));
}

function setCookie(name, value, days=365){
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value))
    + ";expires=" + d.toUTCString() + ";path=/";
}
function getCookie(name){
  const cookies = document.cookie.split("; ");
  for(const c of cookies){
    const parts = c.split("=");
    const k = parts[0];
    const v = parts.slice(1).join("=");
    if(k === name){
      try{ return JSON.parse(decodeURIComponent(v)); }catch{ return null; }
    }
  }
  return null;
}

let historyData = getCookie(COOKIE_HISTORY_KEY) || {}; // key: question.id
function saveHistory(){ setCookie(COOKIE_HISTORY_KEY, historyData); }

function clearHistory(){
  if(!confirm("å±¥æ­´ï¼ˆæ­£è§£/ä¸æ­£è§£ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
  historyData = {};
  saveHistory();
  render();
  alert("å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
}

/********************
  çŠ¶æ…‹
********************/
const app = document.getElementById("app");
let sections = loadSections();

let sectionIndex = 0;
let questionIndex = 0;
let built = [];
let pool = [];
let locked = false;
let hintOpen = false;

// å¤§å•ã®ä»Šå›ã‚¹ã‚³ã‚¢ï¼ˆå‘¨å›ï¼‰
let score = 0;
let wrongList = []; // {jp, correct, explain, yours}
let answeredSet = new Set(); // question.idï¼ˆå‘¨å›å†…ã®äºŒé‡ã‚«ã‚¦ãƒ³ãƒˆé˜²æ­¢ï¼‰

// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
let editorOpen = false;

/********************
  å¤§å•ã‚¢ã‚¯ã‚»ã‚¹
********************/
function currentSection(){ return sections[sectionIndex]; }
function currentQuestion(){ return currentSection().questions[questionIndex]; }
function totalSections(){ return sections.length; }

/********************
  å±¥æ­´ï¼ˆå€‹åˆ¥ï¼‰
********************/
function getHist(qid){ return historyData[qid] || null; }
function updateHist(qid, correct, yourAnswer, correctAnswer){
  const prev = historyData[qid] || {tries:0, correctCount:0, wrongCount:0, mistakes:[], commonMistake:null, diffs:{order:0,end:0}};
  prev.tries += 1;
  if(correct){ prev.correctCount += 1; prev.lastMistake = null; }
  else{ prev.wrongCount += 1; prev.lastMistake = yourAnswer; }
  prev.lastAnswer = yourAnswer;

  // ç°¡æ˜“ãƒŸã‚¹åˆ¤å®šï¼šèªé †ï¼æ–‡æœ«è¨˜å·ï¼ˆå¤§æ–‡å­—ã¯åˆ¤å®šã—ãªã„ï¼‰
  if(!correct){
    const u = normalize(yourAnswer);
    const a = normalize(correctAnswer);
    const uEnd = u.slice(-1);
    const aEnd = a.slice(-1);
    if(uEnd !== aEnd) prev.diffs.end += 1;

    const uw = u.replace(/[?.!]$/,'').split(/\s+/);
    const aw = a.replace(/[?.!]$/,'').split(/\s+/);
    if(uw.join('|') !== aw.join('|')) prev.diffs.order += 1;

    // mistakes list (max 5 unique)
    const next = [yourAnswer, ...(prev.mistakes||[])];
    const uniq = [];
    const seen = new Set();
    for(const m of next){
      if(!m) continue;
      if(!seen.has(m)){
        uniq.push(m);
        seen.add(m);
      }
      if(uniq.length >= 5) break;
    }
    prev.mistakes = uniq;

    const entries = [["èªé †", prev.diffs.order],["æ–‡æœ«ã®è¨˜å·", prev.diffs.end]];
    entries.sort((x,y)=>y[1]-x[1]);
    prev.commonMistake = entries[0][1] > 0 ? entries[0][0] : null;
  }

  historyData[qid] = prev;
  saveHistory();
}

/********************
  è¡¨ç¤º
********************/
function render(){
  if(editorOpen){
    renderEditor();
  }else{
    renderPlay();
  }
}

function renderPlay(){
  const sec = currentSection();
  const q = currentQuestion();
  const hist = getHist(q.id);

  const sNo = sectionIndex + 1;
  const qNo = questionIndex + 1;
  const qTotal = sec.questions.length;

  const histHtml = hist ? `
    <div class="meta">
      ğŸ“Š è¨˜éŒ²ï¼š<b>${hist.correctCount||0}å‹ / ${hist.wrongCount||0}æ•—</b>ï¼ˆæŒ‘æˆ¦ ${hist.tries||0}å›ï¼‰
      ${hist.lastAnswer ? `<br>ğŸ“ å‰å›ã®è§£ç­”ï¼š <i>${escapeHtml(hist.lastAnswer)}</i>` : ""}
      ${hist.lastMistake ? `<br>âš ï¸ å‰å›ã®ãƒŸã‚¹ï¼š <i>${escapeHtml(hist.lastMistake)}</i>` : ""}
      ${hist.commonMistake ? `<br>ğŸ“Œ ã‚ˆãã‚ã‚‹ãƒŸã‚¹ï¼š <b>${escapeHtml(hist.commonMistake)}</b>` : ""}
    </div>
  ` : `<div class="meta">ğŸ“Š ã“ã®å•é¡Œã¯ã¾ã è§£ã„ã¦ã„ã¾ã›ã‚“</div>`;

  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="meta"><b>${escapeHtml(sec.title)}</b>ï¼ˆå¤§å• ${sNo}/${totalSections()}ï¼‰</div>
          <div class="meta">å•é¡Œ ${qNo}/${qTotal}</div>
        </div>
        <div class="row">
          <button class="ctrl gray" onclick="prevQuestion()">æˆ»ã‚‹</button>
          <button class="ctrl gray" onclick="resetQuestion()">ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="ctrl green" onclick="toggleHint()">ãƒ’ãƒ³ãƒˆ</button>
          <button class="ctrl" onclick="nextQuestionManual()">æ¬¡ã¸</button>
        </div>
      </div>

      <div class="jp">${escapeHtml(q.jp)}</div>
      ${histHtml}

      <div style="margin-top:10px;">
        <div class="meta" style="margin:8px 0 6px;"><b>ã‚ãªãŸã®æ–‡ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™ï¼‰</b></div>
        <div id="built" class="box"></div>

        <div class="meta" style="margin:12px 0 6px;"><b>å˜èªï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ä¸Šã«å…¥ã‚‹ï¼‰</b></div>
        <div id="pool" class="box"></div>

        <div id="result" class="result"></div>
        <div id="hintPanel" class="panel hint" style="display:none;"></div>
        <div id="explainPanel" class="panel explain" style="display:none;"></div>
        <div id="logPanel" class="panel log" style="display:none;"></div>
      </div>
    </div>
  `;

  // åˆæœŸé…ç½®
  if(pool.length === 0 && built.length === 0){
    pool = shuffle(q.tokens || []);
  }

  drawWords();
  renderHintPanel();
}

function drawWords(){
  const builtDiv = document.getElementById("built");
  const poolDiv = document.getElementById("pool");
  if(!builtDiv || !poolDiv) return;

  builtDiv.innerHTML = "";
  poolDiv.innerHTML = "";

  built.forEach((w,i)=>{
    const btn = document.createElement("button");
    btn.textContent = w;
    btn.className = "built";
    btn.disabled = locked;
    btn.onclick = ()=>{
      pool.push(w);
      built.splice(i,1);
      drawWords();
      // çµ„ã¿ç«‹ã¦é€”ä¸­ã¯çµæœã‚’éš ã™
      hidePanelsWhenEditing();
    };
    builtDiv.appendChild(btn);
  });

  pool.forEach((w,i)=>{
    const btn = document.createElement("button");
    btn.textContent = w;
    btn.className = "word";
    btn.disabled = locked;
    btn.onclick = ()=>{
      built.push(w);
      pool.splice(i,1);
      drawWords();
      autoCheck();
    };
    poolDiv.appendChild(btn);
  });
}

function hidePanelsWhenEditing(){
  const result = document.getElementById("result");
  const explain = document.getElementById("explainPanel");
  const log = document.getElementById("logPanel");
  if(result) result.textContent = "";
  if(explain) explain.style.display = "none";
  if(log) log.style.display = "none";
}

/********************
  ãƒ’ãƒ³ãƒˆ
********************/
function toggleHint(){
  hintOpen = !hintOpen;
  renderHintPanel();
}

function renderHintPanel(){
  const panel = document.getElementById("hintPanel");
  if(!panel) return;

  if(!hintOpen){
    panel.style.display = "none";
    panel.innerHTML = "";
    return;
  }

  const q = currentQuestion();
  const hist = getHist(q.id);
  let extra = "";
  if(hist){
    if(hist.commonMistake){ extra += `<br>ğŸ“Œ ã‚ˆãã‚ã‚‹ãƒŸã‚¹ï¼š<b>${escapeHtml(hist.commonMistake)}</b>`; }
    if(Array.isArray(hist.mistakes) && hist.mistakes.length){
      extra += `<br><b>æœ€è¿‘ã®ãƒŸã‚¹ï¼ˆæœ€å¤§5ï¼‰</b><br><ol style="margin:6px 0 0 18px; padding:0;">`;
      extra += hist.mistakes.map(m=>`<li style="margin:4px 0;">${escapeHtml(m)}</li>`).join("");
      extra += `</ol>`;
    }
  }

  panel.style.display = "block";
  panel.innerHTML = `<b>ãƒ’ãƒ³ãƒˆ</b><br>${escapeHtml(q.hint || "ï¼ˆãƒ’ãƒ³ãƒˆæœªè¨­å®šï¼‰")}${extra}`;
}

/********************
  æ¡ç‚¹ï¼ˆå¼·åˆ¶æ¡ç‚¹ï¼‰
********************/
function makeSentence(){
  const q = currentQuestion();
  let sentence = built.join(" ").trim();
  if(!sentence) return "";
  if(!sentence.endsWith(".") && !sentence.endsWith("?")){
    sentence += (String(q.answer||"").trim().endsWith("?")) ? "?" : ".";
  }
  return sentence;
}

function autoCheck(){
  const q = currentQuestion();
  if(built.length !== (q.tokens||[]).length) return;

  locked = true;

  const sentence = makeSentence();
  const correct = (normalize(sentence) === normalize(q.answer||""));

  // å¤§å•ã®ä»Šå›æˆç¸¾
  if(!answeredSet.has(q.id)){
    answeredSet.add(q.id);
    if(correct){
      score += 1;
    }else{
      wrongList.push({ jp:q.jp, correct:q.answer, explain:q.explain, yours: sentence });
    }
  }

  // å±¥æ­´æ›´æ–°
  updateHist(q.id, correct, sentence, q.answer||"");

  // è¡¨ç¤º
  const result = document.getElementById("result");
  const explain = document.getElementById("explainPanel");
  const log = document.getElementById("logPanel");

  if(correct){
    result.className = "result correct";
    result.textContent = "æ­£è§£ï¼ï¼ğŸ‰";
    if(log){ log.style.display = "none"; log.innerHTML = ""; }
  }else{
    result.className = "result wrong";
    result.textContent = `ä¸æ­£è§£ï¼\næ­£è§£ï¼š ${currentQuestion().answer}`;
    if(log){
      log.style.display = "block";
      const hist = getHist(q.id);
      log.innerHTML = `
        <b>ã‚ãªãŸã®è§£ç­”</b><br>${escapeHtml(sentence)}
        ${hist && hist.commonMistake ? `<br><br>ğŸ“Œ ãƒŸã‚¹å‚¾å‘ï¼š<b>${escapeHtml(hist.commonMistake)}</b>` : ""}
      `;
    }
  }

  if(explain){
    explain.style.display = "block";
    explain.innerHTML = `<b>è§£èª¬</b><br>${q.explain ? q.explain : "ï¼ˆè§£èª¬æœªè¨­å®šï¼‰"}`;
  }

  // ã¡ã‚‡ã„å¾…ã£ã¦æ¬¡ã¸ï¼ˆå¤§å•æœ«å°¾ãªã‚‰çµæœï¼‰
  setTimeout(()=>{
    if(questionIndex + 1 >= currentSection().questions.length){
      showGroupModal();
    }else{
      questionIndex += 1;
      resetQuestion();
    }
  }, 900);
}

function resetQuestion(){
  const q = currentQuestion();
  built = [];
  pool = shuffle(q.tokens || []);
  locked = false;
  hintOpen = false;
  render();
}

/********************
  æ‰‹å‹•ç§»å‹•
********************/
function nextQuestionManual(){
  // ã¾ã æ¡ç‚¹å‰ã§ã‚‚ç§»å‹•ã§ãã‚‹ï¼ˆå­¦ç¿’ä¸Šã¯ä¾¿åˆ©ï¼‰
  if(questionIndex + 1 >= currentSection().questions.length){
    showGroupModal();
    return;
  }
  questionIndex += 1;
  resetQuestion();
}

function prevQuestion(){
  if(questionIndex <= 0) return;
  questionIndex -= 1;
  resetQuestion();
}

/********************
  å¤§å•çµæœãƒ¢ãƒ¼ãƒ€ãƒ«
********************/
function backdropClose(e){
  if(e.target && e.target.id === "groupModal") closeGroupModal();
}

function showGroupModal(){
  const sec = currentSection();
  const total = sec.questions.length;
  const correct = score;
  const wrong = total - correct;
  const rate = Math.round((correct/total)*100);

  const title = document.getElementById("groupModalTitle");
  const body = document.getElementById("groupModalBody");
  const miss = document.getElementById("groupModalMiss");

  title.textContent = `${sec.title} ã®çµæœ`;
  body.innerHTML = `
    <b>ä»Šå›ã®çµæœ</b><br>
    æ­£è§£ï¼š<b>${correct}</b> / ${total}<br>
    ä¸æ­£è§£ï¼š<b>${wrong}</b><br>
    æ­£ç­”ç‡ï¼š<b>${rate}%</b><br>
    <div style="margin-top:8px; color:#6b7280; font-size:12px;">â€»ã“ã®çµæœã¯ã€Œã“ã®å‘¨å›ã®å¤§å•ã€ã ã‘ã®ã‚¹ã‚³ã‚¢ã§ã™ï¼ˆå±¥æ­´ã¯åˆ¥ã§ä¿å­˜ï¼‰ã€‚</div>
  `;

  if(wrongList.length){
    miss.style.display = "block";
    miss.innerHTML = `<b>é–“é•ãˆãŸå•é¡Œï¼ˆå¾©ç¿’ç”¨ï¼‰</b><br><ol style="margin:6px 0 0 18px; padding:0;">` +
      wrongList.map(x=>`
        <li style="margin:10px 0;">
          ${escapeHtml(x.jp)}<br>
          æ­£è§£ï¼š<b>${escapeHtml(x.correct)}</b><br>
          ã‚ãªãŸï¼š${escapeHtml(x.yours)}
        </li>
      `).join("") + `</ol>`;
  }else{
    miss.style.display = "none";
    miss.innerHTML = "";
  }

  document.getElementById("groupModal").style.display = "flex";
}

function closeGroupModal(){
  document.getElementById("groupModal").style.display = "none";
}

function retrySection(){
  // å¤§å•ã‚’æœ€åˆã‹ã‚‰ï¼ˆå‘¨å›ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
  score = 0;
  wrongList = [];
  answeredSet = new Set();
  questionIndex = 0;
  closeGroupModal();
  resetQuestion();
}

function goNextSection(){
  if(sectionIndex + 1 >= sections.length){
    closeGroupModal();
    app.innerHTML = `
      <div class="card">
        <div class="bigResult">ğŸ‰ å…¨å¤§å•ã‚¯ãƒªã‚¢ï¼</div>
        <div class="meta" style="text-align:center;">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§å¤§å•ã‚’å¢—ã‚„ã›ã¾ã™ã€‚</div>
        <div class="controls" style="justify-content:center; margin-top:12px;">
          <button class="ctrl gray" onclick="retrySection()">æœ€å¾Œã®å¤§å•ã‚’ã‚‚ã†ä¸€å›</button>
          <button class="ctrl" onclick="toggleEditor()">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸</button>
        </div>
      </div>
    `;
    return;
  }

  sectionIndex += 1;
  score = 0;
  wrongList = [];
  answeredSet = new Set();
  questionIndex = 0;
  closeGroupModal();
  resetQuestion();
}

/********************
  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
********************/
function toggleEditor(){
  editorOpen = !editorOpen;
  document.getElementById("btnEditor").textContent = editorOpen ? "ãƒ—ãƒ¬ã‚¤ã«æˆ»ã‚‹" : "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
  render();
}

function renderEditor(){
  const sec = currentSection();
  const q = currentQuestion();

  app.innerHTML = `
    <div class="card editor" style="display:block;">
      <h2>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</h2>
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div class="field" style="min-width:260px; flex:1;">
          <label>å¤§å•</label>
          <select id="edSection" onchange="onChangeSection(this.value)"></select>
          <div class="small">â€»ç·¨é›†å†…å®¹ã¯ã“ã®ç«¯æœ«ã«ä¿å­˜ï¼ˆlocalStorageï¼‰</div>
        </div>
        <div class="row">
          <button class="ctrl" onclick="addSection()">ï¼‹å¤§å•è¿½åŠ </button>
          <button class="ctrl danger" onclick="deleteSection()">å¤§å•å‰Šé™¤</button>
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="field">
          <label>å¤§å•ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="edSectionTitle" value="${escapeHtml(sec.title)}" />
        </div>
        <div class="field">
          <label>å•é¡Œ</label>
          <select id="edQuestion" onchange="onChangeQuestion(this.value)"></select>
          <div class="row" style="margin-top:8px;">
            <button class="ctrl" onclick="addQuestion()">ï¼‹å•é¡Œè¿½åŠ </button>
            <button class="ctrl danger" onclick="deleteQuestion()">å•é¡Œå‰Šé™¤</button>
          </div>
        </div>

        <div class="field">
          <label>æ—¥æœ¬èªï¼ˆå•é¡Œæ–‡ï¼‰</label>
          <textarea id="edJp">${escapeHtml(q.jp||"")}</textarea>
        </div>
        <div class="field">
          <label>æ­£è§£è‹±æ–‡ï¼ˆanswerï¼‰</label>
          <textarea id="edAnswer">${escapeHtml(q.answer||"")}</textarea>
          <div class="small">æ¡ç‚¹ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ã—ã¾ã™ã€‚</div>
        </div>

        <div class="field">
          <label>å˜èªã‚¿ã‚¤ãƒ«ï¼ˆtokensï¼‰</label>
          <textarea id="edTokens" placeholder="1è¡Œã«1ãƒˆãƒ¼ã‚¯ãƒ³">${escapeHtml((q.tokens||[]).join("\n"))}</textarea>
          <div class="small">ä¾‹ï¼šthis summer ã¿ãŸã„ã«ã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šãƒˆãƒ¼ã‚¯ãƒ³OK</div>
        </div>
        <div class="field">
          <label>ãƒ’ãƒ³ãƒˆï¼ˆhintï¼‰</label>
          <textarea id="edHint">${escapeHtml(q.hint||"")}</textarea>
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label>è§£èª¬ï¼ˆexplainï¼‰</label>
          <textarea id="edExplain">${escapeHtml(q.explain||"")}</textarea>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="ctrl green" onclick="saveEdits()">ä¿å­˜</button>
        <button class="ctrl gray" onclick="resetDataToDefault()">åˆæœŸåŒ–ï¼ˆå…ƒã«æˆ»ã™ï¼‰</button>
      </div>
    </div>
  `;

  // populate selects
  const secSel = document.getElementById("edSection");
  secSel.innerHTML = "";
  sections.forEach((s,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i+1}. ${s.title}`;
    secSel.appendChild(opt);
  });
  secSel.value = String(sectionIndex);

  const qSel = document.getElementById("edQuestion");
  qSel.innerHTML = "";
  currentSection().questions.forEach((qq,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    const label = (qq.jp||"").slice(0,22);
    opt.textContent = `${i+1}. ${label}${(qq.jp||"").length>22?"â€¦":""}`;
    qSel.appendChild(opt);
  });
  qSel.value = String(questionIndex);
}

function onChangeSection(v){
  sectionIndex = Number(v);
  questionIndex = 0;
  render();
}

function onChangeQuestion(v){
  questionIndex = Number(v);
  render();
}

function saveEdits(){
  const secTitle = document.getElementById("edSectionTitle").value.trim();
  const jp = document.getElementById("edJp").value.trim();
  const ans = document.getElementById("edAnswer").value.trim();
  const toks = document.getElementById("edTokens").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const hint = document.getElementById("edHint").value.trim();
  const exp = document.getElementById("edExplain").value.trim();

  if(!secTitle){ alert("å¤§å•ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™"); return; }
  if(!jp || !ans || toks.length === 0){
    alert("æ—¥æœ¬èª / æ­£è§£è‹±æ–‡ / tokens ã¯å¿…é ˆã§ã™");
    return;
  }

  const sec = currentSection();
  sec.title = secTitle;

  const q = currentQuestion();
  q.jp = jp;
  q.answer = ans;
  q.tokens = toks;
  q.hint = hint;
  q.explain = exp;
  if(!q.id) q.id = "q-" + Math.random().toString(36).slice(2,9);

  saveSections();
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  render();
}

function addSection(){
  const n = sections.length + 1;
  sections.push({
    title:`å¤§å•${n}`,
    questions:[{
      id:"q-"+Math.random().toString(36).slice(2,9),
      jp:"ï¼ˆã“ã“ã«æ—¥æœ¬èªï¼‰",
      tokens:["(token1)","(token2)"],
      answer:"(answer).",
      hint:"ï¼ˆãƒ’ãƒ³ãƒˆï¼‰",
      explain:"ï¼ˆè§£èª¬ï¼‰",
    }]
  });
  saveSections();
  sectionIndex = sections.length - 1;
  questionIndex = 0;
  render();
}

function deleteSection(){
  if(sections.length <= 1){ alert("æœ€å¾Œã®å¤§å•ã¯å‰Šé™¤ã§ãã¾ã›ã‚“"); return; }
  if(!confirm("ã“ã®å¤§å•ã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
  sections.splice(sectionIndex, 1);
  saveSections();
  sectionIndex = Math.min(sectionIndex, sections.length - 1);
  questionIndex = 0;
  render();
}

function addQuestion(){
  const sec = currentSection();
  sec.questions.push({
    id:"q-"+Math.random().toString(36).slice(2,9),
    jp:"ï¼ˆã“ã“ã«æ—¥æœ¬èªï¼‰",
    tokens:["(token1)","(token2)"],
    answer:"(answer).",
    hint:"ï¼ˆãƒ’ãƒ³ãƒˆï¼‰",
    explain:"ï¼ˆè§£èª¬ï¼‰",
  });
  saveSections();
  questionIndex = sec.questions.length - 1;
  render();
}

function deleteQuestion(){
  const sec = currentSection();
  if(sec.questions.length <= 1){ alert("æœ€å¾Œã®1å•ã¯å‰Šé™¤ã§ãã¾ã›ã‚“"); return; }
  if(!confirm("ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
  const q = currentQuestion();
  // å±¥æ­´ã‚‚æ¶ˆã—ãŸã„å ´åˆï¼šdelete historyData[q.id]
  sec.questions.splice(questionIndex, 1);
  saveSections();
  questionIndex = Math.min(questionIndex, sec.questions.length - 1);
  render();
}

function resetDataToDefault(){
  if(!confirm("å•é¡Œã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ï¼ˆç·¨é›†å†…å®¹ã¯æ¶ˆãˆã¾ã™ï¼‰ã€‚OKï¼Ÿ")) return;
  localStorage.removeItem(LS_SECTIONS_KEY);
  sections = loadSections();
  sectionIndex = 0;
  questionIndex = 0;
  score = 0;
  wrongList = [];
  answeredSet = new Set();
  built = [];
  pool = [];
  locked = false;
  hintOpen = false;
  render();
}

/********************
  èµ·å‹•
********************/
// åˆå›ãƒ—ãƒ¬ã‚¤ç”»é¢
resetQuestion();

</script>
</body>
</html>
